{% extends "layout.html" %}
{% block content %}
<main class="container" style="padding: 20px; border-radius: 8px; margin-top: 20px;">   
    <div class="d-flex justify-content-between align-items-center mb-4">
        <!-- Formulario de búsqueda -->
        <form class="row g-2 align-items-center">
            <div class="col-auto">
              <label for="inputProvider" class="form-label mb-0">Nombre del Vendedor a buscar: </label>
            </div>
            <div class="col-auto">
              <input type="text" class="form-control" id="inputProvider" placeholder="nombre del vendedor">
            </div>
        </form>

        <!-- Botón para abrir el modal de agregar vendedor -->
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalAgregar">
            Agregar Vendedor
        </button>
    </div>

    <!-- Tabla de vendedores -->
    <div class="table-container" id="tabla-proveedores" style="max-height: 400px; overflow-y: auto; border: 1px solid #ccc;">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th scope="col" style="color:#7c8c3c;">ID</th>
                    <th scope="col" style="color:#7c8c3c;">Nombres</th>
                    <th scope="col" style="color:#7c8c3c;">Apellidos</th>
                    <th scope="col" style="color:#7c8c3c;">Empresa</th>
                    <th scope="col" style="color:#7c8c3c;">Teléfono</th>
                    <th scope="col" style="color:#7c8c3c;">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for proveedor in proveedores %}
                <tr class="us_proveedor">
                    <td>{{ proveedor.id }}</td>
                    <td>{{ proveedor.nombres }}</td>
                    <td>{{ proveedor.apellidos }}</td>
                    <td>{{ proveedor.empresa }}</td>
                    <td>{{ proveedor.telefono }}</td>
                    <td>
                        <!-- Botón para abrir el modal de edición -->
                        <button class="btn btn-warning btn-sm" 
                                data-bs-toggle="modal" 
                                data-bs-target="#modalEditar" 
                                data-id="{{ proveedor.id }}" 
                                data-nombres="{{ proveedor.nombres }}" 
                                data-apellidos="{{ proveedor.apellidos }}" 
                                data-empresa="{{ proveedor.empresa }}" 
                                data-telefono="{{ proveedor.telefono }}">
                            Editar
                        </button>
                        <!-- Botón para eliminar -->
                        <button class="btn btn-danger btn-sm" 
                                data-bs-toggle="modal" 
                                data-bs-target="#modalEliminar" 
                                data-id="{{ proveedor.id }}">
                            Eliminar
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Modales para agregar, editar y eliminar vendedores -->
    <!-- Modal para agregar vendedor -->
    <div class="modal fade" id="modalAgregar" tabindex="-1" aria-labelledby="modalAgregarLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form id="formAgregar">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalAgregarLabel">Agregar Vendedor</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="nombresAgregar" class="form-label">Nombres</label>
                            <input type="text" class="form-control" id="nombresAgregar" required>
                        </div>
                        <div class="mb-3">
                            <label for="apellidosAgregar" class="form-label">Apellidos</label>
                            <input type="text" class="form-control" id="apellidosAgregar" required>
                        </div>
                        <div class="mb-3">
                            <label for="empresaAgregar" class="form-label">Empresa</label>
                            <input type="text" class="form-control" id="empresaAgregar" required>
                        </div>
                        <div class="mb-3">
                            <label for="telefonoAgregar" class="form-label">Teléfono</label>
                            <input type="text" class="form-control" id="telefonoAgregar" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para editar vendedor -->
    <div class="modal fade" id="modalEditar" tabindex="-1" aria-labelledby="modalEditarLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form id="formEditar">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalEditarLabel">Editar Vendedor</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="idEditar">
                        <div class="mb-3">
                            <label for="nombresEditar" class="form-label">Nombres</label>
                            <input type="text" class="form-control" id="nombresEditar" required>
                        </div>
                        <div class="mb-3">
                            <label for="apellidosEditar" class="form-label">Apellidos</label>
                            <input type="text" class="form-control" id="apellidosEditar" required>
                        </div>
                        <div class="mb-3">
                            <label for="empresaEditar" class="form-label">Empresa</label>
                            <input type="text" class="form-control" id="empresaEditar" required>
                        </div>
                        <div class="mb-3">
                            <label for="telefonoEditar" class="form-label">Teléfono</label>
                            <input type="text" class="form-control" id="telefonoEditar" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para confirmar eliminación -->
    <div class="modal fade" id="modalEliminar" tabindex="-1" aria-labelledby="modalEliminarLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalEliminarLabel">Confirmar Eliminación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    ¿Estás seguro de que deseas eliminar este vendedor?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button id="btnConfirmarEliminar" class="btn btn-danger">Eliminar</button>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const inputProvider = document.getElementById('inputProvider');
        const formAgregar = document.getElementById('formAgregar');
        const formEditar = document.getElementById('formEditar');
        const btnConfirmarEliminar = document.getElementById('btnConfirmarEliminar');
        let idProveedorAEliminar = null;
    
        // Búsqueda de proveedores
        inputProvider.addEventListener('input', function() {
            let query = this.value;
    
            fetch(`/buscar_proveedores?query=${query}`)
                .then(response => response.json())
                .then(data => {
                    let results = data.proveedores;
                    let tableBody = document.querySelector('#tabla-proveedores tbody');
                    tableBody.innerHTML = ''; // Limpiar los resultados anteriores
    
                    results.forEach(proveedor => {
                        let row = document.createElement('tr');
                        row.setAttribute('data-id', proveedor.id); // Añadir atributo data-id
                        row.classList.add('us_proveedor');
                        row.innerHTML = `
                            <td>${proveedor.id}</td>
                            <td>${proveedor.nombres}</td>
                            <td>${proveedor.apellidos}</td>
                            <td>${proveedor.empresa}</td>
                            <td>${proveedor.telefono}</td>
                            <td>
                                <button class="btn btn-warning btn-sm" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#modalEditar" 
                                        data-id="${proveedor.id}" 
                                        data-nombres="${proveedor.nombres}" 
                                        data-apellidos="${proveedor.apellidos}" 
                                        data-empresa="${proveedor.empresa}" 
                                        data-telefono="${proveedor.telefono}">
                                    Editar
                                </button>
                                <button class="btn btn-danger btn-sm" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#modalEliminar" 
                                        data-id="${proveedor.id}">
                                    Eliminar
                                </button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                })
                .catch(error => console.error('Error:', error));
        });
    
        // Agregar proveedor
        formAgregar.addEventListener('submit', function(event) {
            event.preventDefault();
    
            let nombres = document.getElementById('nombresAgregar').value;
            let apellidos = document.getElementById('apellidosAgregar').value;
            let empresa = document.getElementById('empresaAgregar').value;
            let telefono = document.getElementById('telefonoAgregar').value;
    
            fetch('/agregar_vendedor', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ nombres, apellidos, empresa, telefono })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    Swal.fire('Éxito', data.message, 'success').then(() => location.reload());
                } else {
                    Swal.fire('Error', 'Hubo un error al agregar el proveedor', 'error');
                }
            })
            .catch(error => console.error('Error:', error));
        });
    
        // Editar proveedor
        formEditar.addEventListener('submit', function(event) {
            event.preventDefault();
    
            let id = document.getElementById('idEditar').value;
            let nombres = document.getElementById('nombresEditar').value;
            let apellidos = document.getElementById('apellidosEditar').value;
            let empresa = document.getElementById('empresaEditar').value;
            let telefono = document.getElementById('telefonoEditar').value;
    
            fetch(`/editar_vendedor/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ nombres, apellidos, empresa, telefono })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    Swal.fire('Éxito', data.message, 'success').then(() => location.reload());
                } else {
                    Swal.fire('Error', 'Hubo un error al editar el proveedor', 'error');
                }
            })
            .catch(error => console.error('Error:', error));
        });
    
        // Eliminar proveedor
        document.querySelectorAll('.btn-danger[data-bs-target="#modalEliminar"]').forEach(button => {
            button.addEventListener('click', function () {
                idProveedorAEliminar = this.getAttribute('data-id');
            });
        });
    
        // Confirmar eliminación con SweetAlert
        btnConfirmarEliminar.addEventListener('click', function () {
            if (idProveedorAEliminar) {
                Swal.fire({
                    title: '¿Estás seguro?',
                    text: 'No podrás revertir esta acción',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Sí, eliminar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch(`/eliminar_proveedor/${idProveedorAEliminar}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.message) {
                                Swal.fire('¡Eliminado!', data.message, 'success');
                                const modalEliminar = document.getElementById('modalEliminar');
                                const modalInstance = bootstrap.Modal.getInstance(modalEliminar);
                                modalInstance.hide();
                                document.querySelector(`tr[data-id="${idProveedorAEliminar}"]`).remove();
                            } else {
                                Swal.fire('Error', data.error || 'Error al eliminar el proveedor', 'error');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            Swal.fire('Error', 'Ocurrió un error al intentar eliminar el proveedor.', 'error');
                        });
                    }
                });
            }
        });
    });
</script>
{% endblock %}
